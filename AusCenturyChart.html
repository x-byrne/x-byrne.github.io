<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chart of the Century — Australia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f8f6f1; color: #1a1812; min-height: 100vh; }
  header { background: #1a1812; padding: 1.5rem 2rem; }
  header h1 { font-size: 1.4rem; color: #f8f6f1; font-weight: 400; }
  header p  { font-size: 0.8rem; color: rgba(255,255,255,0.45); margin-top: 0.25rem; }
  main { max-width: 1200px; margin: 0 auto; padding: 1.5rem 1.5rem 3rem; }
  
  .toolbar {
    display: flex; flex-direction: column; gap: 1rem;
    margin-bottom: 1.5rem; background: #fff; padding: 1.25rem;
    border-radius: 6px; border: 1px solid #e8e4da; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  }
  .tool-row { display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; }
  .tool-group { display: flex; align-items: center; gap: 0.75rem; }
  .toolbar span { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: #999; font-weight: 700; }
  
  .seg { display: inline-flex; background: #e8e4da; border-radius: 20px; padding: 3px; }
  .seg button {
    font-size: 0.7rem; letter-spacing: 0.05em; padding: 0.35rem 0.9rem;
    border: none; background: transparent; color: #777; cursor: pointer;
    border-radius: 16px; transition: all 0.2s;
  }
  .seg button.active { background: #1a1812; color: #f8f6f1; font-weight: 500; }

  .slider-container { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 300px; }
  .range-box { position: relative; flex: 1; height: 20px; }
  input[type="range"] {
    position: absolute; width: 100%; pointer-events: none; appearance: none; height: 100%; background: none; z-index: 2;
  }
  input[type="range"]::-webkit-slider-thumb {
    height: 18px; width: 18px; border-radius: 50%; background: #1a1812; pointer-events: auto; appearance: none; cursor: pointer; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .slider-track {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 100%; height: 4px; background: #e8e4da; border-radius: 2px; z-index: 1;
  }
  #date-label { font-size: 0.75rem; font-weight: 600; color: #1a1812; min-width: 140px; text-align: right; }

  .chart-box {
    background: #fff; border: 1px solid #e8e4da; border-radius: 6px;
    padding: 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    height: 600px; position: relative;
  }
  #status { font-size: 0.78rem; color: #888; margin-bottom: 1rem; min-height: 1.2em; }
  #error  { color: #b84040; font-size: 0.85rem; margin-bottom: 1rem; display: none; padding: 1rem; background: #fff1f1; border-radius: 4px; }
</style>
</head>
<body>

<header>
  <h1>Chart of the Century — Australia</h1>
  <p>Price Series (CPI/LCI) vs. Earnings (AWE/WPI) &middot; ABS · cdn.jsdelivr.net/gh/x-byrne/AusAbund@main</p>
</header>

<main>
  <div id="status">Loading data...</div>
  <div id="error"></div>

  <div class="toolbar">
    <div class="tool-row">
      <div class="tool-group">
        <span>Prices</span>
        <div class="seg" id="seg-prices">
          <button class="active" data-val="cpi">CPI Groups</button>
          <button data-val="lci">LCI Groups</button>
        </div>
      </div>
      <div class="tool-group">
        <span>Income</span>
        <div class="seg" id="seg-income">
          <button class="active" data-val="awe">AWE</button>
          <button data-val="wpi">WPI</button>
        </div>
      </div>
      <div class="tool-group">
        <span>Display</span>
        <div class="seg" id="seg-mode">
          <button class="active" data-val="index">Indexed</button>
          <button data-val="ratio">Relative to Income</button>
        </div>
      </div>
    </div>

    <div class="tool-row">
      <div class="tool-group">
        <span>Period</span>
        <div class="seg" id="seg-period">
          <button data-val="20">5Y</button>
          <button data-val="40">10Y</button>
          <button class="active" data-val="0">All Time</button>
        </div>
      </div>
      <div class="slider-container">
        <div class="range-box">
          <div class="slider-track"></div>
          <input type="range" id="range-min" value="0">
          <input type="range" id="range-max" value="0">
        </div>
        <div id="date-label">Initializing...</div>
      </div>
    </div>
  </div>

  <div class="chart-box">
    <canvas id="chart"></canvas>
  </div>
</main>

<script>
const BASE_URL = 'https://cdn.jsdelivr.net/gh/x-byrne/AusAbund@main/data/';
const URLS = {
  cpigroups: BASE_URL + 'cpigroups/cpigroups.csv',
  lcigroups: BASE_URL + 'lcigroups/lcigroups.csv',
  awe:       BASE_URL + 'awe/awe.csv',
  wpi:       BASE_URL + 'wpi/wpi.csv'
};

const GROUP_NAMES = {
  '10001': 'All groups',
  '20001': 'Food & non-alcoholic beverages',
  '20002': 'Clothing & footwear',
  '20003': 'Housing',
  '20004': 'Furnishings & equipment',
  '20005': 'Transport',
  '20006': 'Alcohol & tobacco',
  '115486': 'Health',
  '115488': 'Communication',
  '115489': 'Recreation & culture',
  '115493': 'Education',
  '126670': 'Insurance & financial services',
  '131278': 'Mortgage interest charges',
  '131279': 'Consumer credit interest'
};

const PALETTE_WARM = ['#e63946', '#f4a261', '#e76f51', '#d62828', '#fcbf49', '#bc4749', '#9b2226'];
const PALETTE_COOL = ['#2a9d8f', '#457b9d', '#1d3557', '#a8dadc', '#7209b7', '#4361ee', '#4cc9f0', '#06d6a0'];

let dataRaw = {}; 
let quarterLabels = [];
let qNums = [];
let chart = null;

let state = {
  prices: 'cpi',
  income: 'awe',
  mode: 'index',
  range: { min: 0, max: 0 }
};

async function init() {
  const status = document.getElementById('status');
  try {
    const responses = await Promise.all(Object.values(URLS).map(url => fetch(url).then(r => r.text())));
    const keys = Object.keys(URLS);
    keys.forEach((key, i) => { dataRaw[key] = parseCSV(responses[i]); });

    const cpiAll = dataRaw.cpigroups.filter(r => r['INDEX'] === '10001');
    qNums = [...new Set(cpiAll.map(r => periodToNum(r['TIME_PERIOD'])))].sort((a,b)=>a-b);
    qNums = qNums.filter(n => n >= 1998.25);

    quarterLabels = qNums.map(n => {
      const yr = Math.floor(n), q = Math.round((n - yr) / 0.25) + 1;
      return `${yr} Q${q}`;
    });

    updateSliderBounds();
    status.textContent = '';
    render();
  } catch(err) {
    status.textContent = '';
    const errEl = document.getElementById('error');
    errEl.style.display = 'block';
    errEl.textContent = 'Error loading data: ' + err.message;
  }
}

function render() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) chart.destroy();

  const start = state.range.min;
  const end = state.range.max;
  const sliceLabels = quarterLabels.slice(start, end + 1);
  const sliceQ = qNums.slice(start, end + 1);

  const incFull = getIncomeSeries(state.income);
  const incSlice = incFull.slice(start, end + 1);
  const incGrowthFactor = incSlice[incSlice.length - 1] / incSlice[0];

  let warmIdx = 0, coolIdx = 0;
  const datasets = [];

  Object.keys(GROUP_NAMES).forEach(code => {
    const pricesFull = getPriceSeries(state.prices, code);
    const pricesSlice = pricesFull.slice(start, end + 1);
    
    // Check for valid data in this slice
    if (!pricesSlice[0] || pricesSlice.every(v => v === null)) return;

    const priceGrowthFactor = pricesSlice[pricesSlice.length - 1] / pricesSlice[0];
    const isWarm = priceGrowthFactor > incGrowthFactor;
    const color = (code === '10001') ? '#1a1812' : 
                (isWarm ? PALETTE_WARM[warmIdx++ % PALETTE_WARM.length] : PALETTE_COOL[coolIdx++ % PALETTE_COOL.length]);

    let displayData;
    if (state.mode === 'index') {
      const base = pricesSlice[0];
      displayData = pricesSlice.map(v => (v / base) * 100);
    } else {
      const baseRatio = pricesSlice[0] / incSlice[0];
      displayData = pricesSlice.map((v, i) => ((v / incSlice[i]) / baseRatio) * 100);
    }

    datasets.push({
      label: GROUP_NAMES[code],
      data: displayData,
      borderColor: color,
      borderWidth: (code === '131278' || code === '10001') ? 3 : 1.5,
      pointRadius: 0,
      tension: 0.1,
      order: (code === '131278' || code === '131279') ? 1 : (code === '10001' ? 2 : 10)
    });
  });

  if (state.mode === 'index') {
    datasets.push({
      label: (state.income === 'awe' ? 'Avg Weekly Earnings' : 'Wage Price Index'),
      data: incSlice.map(v => (v / incSlice[0]) * 100),
      borderColor: '#888',
      borderWidth: 3,
      borderDash: [8, 4],
      pointRadius: 0,
      order: 0
    });
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: sliceLabels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
        tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.parsed.y.toFixed(1)}` } }
      },
      scales: {
        y: { 
          title: { display: true, text: 'Index (Start of Selection = 100)', font: { size: 11, weight: 'bold' } },
          ticks: { font: { size: 10 } }
        },
        x: { ticks: { font: { size: 10 }, maxTicksLimit: 12 } }
      }
    }
  });
}

function getPriceSeries(type, code) {
  const cpiMap = dataToMap(dataRaw.cpigroups.filter(r => r['INDEX'] === code));
  const lciMap = (type === 'lci') ? dataToMap(dataRaw.lcigroups.filter(r => r['INDEX'] === code)) : {};

  return qNums.map(q => {
    if (type === 'lci') {
      // Prioritize LCI value if it exists for this quarter
      if (lciMap[q] !== undefined && lciMap[q] !== null && !isNaN(lciMap[q])) {
        return lciMap[q];
      }
      // If LCI is missing (e.g. pre-2007), fallback to CPI
      return cpiMap[q] !== undefined ? cpiMap[q] : null;
    }
    // Standard CPI View
    return cpiMap[q] !== undefined ? cpiMap[q] : null;
  });
}

function getIncomeSeries(type) {
  if (type === 'wpi') {
    const wpiMap = dataToMap(dataRaw.wpi);
    return qNums.map(q => wpiMap[q] || null);
  } else {
    const pts = dataRaw.awe.map(r => ({ num: periodToNum(r['TIME_PERIOD']), val: parseFloat(r['OBS_VALUE']) }))
                 .filter(p => !isNaN(p.val)).sort((a,b)=>a.num-b.num);
    return qNums.map(q => {
      const ex = pts.find(p => Math.abs(p.num - q) < 0.01);
      if (ex) return ex.val;
      const b = [...pts].reverse().find(p => p.num < q), a = pts.find(p => p.num > q);
      return (!b || !a) ? null : b.val + (q - b.num) / (a.num - b.num) * (a.val - b.val);
    });
  }
}

function updateSliderBounds() {
  const incSeries = getIncomeSeries(state.income);
  const first = incSeries.findIndex(v => v !== null);
  const last = incSeries.length - 1 - [...incSeries].reverse().findIndex(v => v !== null);

  const minS = document.getElementById('range-min'), maxS = document.getElementById('range-max');
  minS.min = maxS.min = first;
  minS.max = maxS.max = last;
  
  state.range.min = first;
  state.range.max = last;
  minS.value = first;
  maxS.value = last;
  
  updateDateLabel();
}

function updateDateLabel() {
  const label = document.getElementById('date-label');
  label.textContent = `${quarterLabels[state.range.min]} — ${quarterLabels[state.range.max]}`;
}

function parseCSV(t) {
  const [h, ...ls] = t.trim().split('\n');
  const heads = h.split(',').map(x => x.trim().replace(/^"|"$/g, ''));
  return ls.map(l => {
    const vs = l.split(',').map(x => x.trim().replace(/^"|"$/g, ''));
    return Object.fromEntries(heads.map((x, i) => [x, vs[i]]));
  });
}
function periodToNum(tp) {
  if (tp.includes('-Q')) { const [y,q] = tp.split('-Q'); return parseInt(y) + (parseInt(q)-1)*0.25; }
  if (tp.includes('-S')) { const [y,s] = tp.split('-S'); return parseInt(y) + (s==='1' ? 0.25 : 0.75); }
  return parseInt(tp);
}
function dataToMap(arr) {
  const m = {};
  arr.forEach(r => { 
    const val = parseFloat(r['OBS_VALUE']);
    if (!isNaN(val)) m[periodToNum(r['TIME_PERIOD'])] = val; 
  });
  return m;
}

document.querySelectorAll('.seg button').forEach(btn => {
  btn.onclick = (e) => {
    const parent = e.target.parentElement;
    parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    const val = e.target.dataset.val;
    const type = parent.id.replace('seg-', '');

    if (type === 'prices') state.prices = val;
    if (type === 'income') { state.income = val; updateSliderBounds(); }
    if (type === 'mode') state.mode = val;
    if (type === 'period') {
      const count = parseInt(val);
      if (count === 0) {
        updateSliderBounds();
      } else {
        state.range.min = Math.max(state.range.min, state.range.max - count);
        document.getElementById('range-min').value = state.range.min;
        updateDateLabel();
      }
    }
    render();
  };
});

const rMin = document.getElementById('range-min'), rMax = document.getElementById('range-max');
rMin.oninput = rMax.oninput = () => {
  let v1 = parseInt(rMin.value), v2 = parseInt(rMax.value);
  state.range.min = Math.min(v1, v2);
  state.range.max = Math.max(v1, v2);
  updateDateLabel();
  render();
};

init();
</script>
</body>
</html>